#include <ESP8266WiFi.h>
#include <Sodaq_DS3231.h>
#include <EEPROM.h>  
#include "mibib.h"
#include <Wire.h> 
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Fonts/FreeSansBold9pt7b.h> // Incluir la fuente
#include <Fonts/FreeSans9pt7b.h>     // Incluir la fuente
#include <Fonts/FreeMono9pt7b.h>  // Incluye una fuente más pequeña

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
// Dirección I2C de la pantalla OLED
#define OLED_RESET    -1
#define SCREEN_ADDRESS 0x3C

//DateTime fecha(2024,07,8,18,05,0,3);////aqui se pone la fecha********************* 

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

String ano="", mes="", dia="", hora="", minuto="", segundos="", temperatura="";
String dia_inicio="", mes_inicia="", dia_termina="", mes_termina="", dia_inicia_flora="", mes_inicia_flora="", mes_termina_flora="";
String fechac="", horac="", datosc="", datosc1="", datosc2="" ;

unsigned long start_time;
int segundo1, minuto1, hora1, dia1, mes1;
int tiempo=0;

const int lampara = 5;            
int boton = 6;
int estadoBoton;

int M;      //mes uno 
int M2;     //mes dos
int temp;


int mes_inicia1;  // mes en que inicia el cultivo, valor que se guarda en la eeprom 
int mes_termina1; 
int dia_inicio1; 
int dia_termina1; 

/////////////////////////////////////////////////para el menu los iconos y logos////////////////////////////////
//// 'icon_1', 16x16px
const unsigned char epd_bitmap_icon_1 [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x3f, 0xc0, 0x3f, 0xe0, 0x38, 0x70, 0x38, 0x70, 0x38, 0x70, 0x38, 0x60, 
	0x3f, 0xc0, 0x3b, 0x00, 0x39, 0x80, 0x38, 0xc0, 0x38, 0x60, 0x38, 0x60, 0x38, 0x70, 0x00, 0x00
};
// 'icon_2', 16x16px
const unsigned char epd_bitmap_icon_2 [] PROGMEM = {
	0x0f, 0xe0, 0x31, 0x18, 0x60, 0x0c, 0x40, 0x04, 0x81, 0x02, 0x81, 0x02, 0x81, 0x02, 0x81, 0x02, 
	0xc1, 0x06, 0x80, 0x82, 0x80, 0x42, 0x80, 0x22, 0x40, 0x04, 0x60, 0x0c, 0x31, 0x18, 0x0f, 0xe0
};
// 'icon_3', 16x16px
const unsigned char epd_bitmap_icon_3 [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x07, 0xe0, 0x0e, 0x70, 0x0e, 0x70, 0x0e, 0x70, 0x0e, 0x70, 0x0e, 0x70, 
	0x0e, 0x70, 0x1f, 0xf8, 0x0e, 0x70, 0x0e, 0x70, 0x0e, 0x70, 0x0e, 0x70, 0x0e, 0x70, 0x00, 0x00
};
// 'icon_fireworks', 16x16px
const unsigned char epd_bitmap_icon_4 [] PROGMEM = {
  0x00, 0x00, 0x00, 0x08, 0x00, 0x94, 0x10, 0x08, 0x10, 0x00, 0x6c, 0x00, 0x10, 0x10, 0x10, 0x10, 
  0x00, 0x00, 0x00, 0xc6, 0x00, 0x00, 0x00, 0x10, 0x04, 0x10, 0x0a, 0x00, 0x04, 0x00, 0x00, 0x00
};
const unsigned char epd_bitmap_icon_5 [] PROGMEM = { ////esta es la imagen del icono para la opcion de floracion
  0x00, 0x00, 0x00, 0x08, 0x00, 0x94, 0x10, 0x08, 0x10, 0x00, 0x6c, 0x00, 0x10, 0x10, 0x10, 0x10, 
  0x00, 0x00, 0x00, 0xc6, 0x00, 0x00, 0x00, 0x10, 0x04, 0x10, 0x0a, 0x00, 0x04, 0x00, 0x00, 0x00
};


const unsigned char* epd_bitmap_icons[5] = {
  epd_bitmap_icon_1,
	epd_bitmap_icon_2,
	epd_bitmap_icon_3,
  epd_bitmap_icon_4,  
  epd_bitmap_icon_5
};

// 'scrollbar_background', 8x64px
const unsigned char bitmap_scrollbar_background [] PROGMEM = {
  0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 
  0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 
  0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 
  0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x02, 0x00, 0x00
};

// 'item_sel_outline', 128x21px
const unsigned char bitmap_item_sel_outline [] PROGMEM = {
  0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 
  0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 
  0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 
  0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 
  0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0
};



// ------------------ end generated bitmaps from image2cpp ---------------------------------
const int NUM_ITEMS = 5; // number of items in the list and also the number of screenshots and screenshots with QR codes (other screens)
const int MAX_ITEM_LENGTH = 20; // maximum characters for the item name

char menu_items [NUM_ITEMS] [MAX_ITEM_LENGTH] = {  // array with item names
  { "Pepino" }, 
  { "datos" },
  { "Tomate" },
  { "Reset cult" } ,
  { "floracion" } 
 };
// Pines para los botones
// Pines para los botones
#define BUTTON_UP_PIN D7
#define BUTTON_DOWN_PIN D8
#define BUTTON_SELECT_PIN D4 // pin for SELECT button
#define BUTTON_PUSH_PIN D3
//salidas
#define vegeta D5
#define flora D6
#define DEMO_PIN D0
#define ldr_pin A0

int current_screen = 0;   // 0 = menu, 1 = screenshot, 2 = qr
int button_select_clicked = 0; // same as above
int button_up_clicked = 0;
int button_down_clicked = 0;
int button_push = 0; 

int item_selected = 0; // which item in the menu is selected
int item_sel_previous; // se utiliza en la pantalla del menú para dibujar el elemento anterior al seleccionado.
int item_sel_next; //  se utiliza en la pantalla del menú para dibujar el siguiente elemento después del seleccionado.

int demo_mode = 0; // 
int demo_mode_state = 0; //  que pantalla he iten mostrar
int demo_mode_delay = 0; // retraso del modo de demostración = utilizado para ralentizar el cambio de pantalla

void setup() {
  Wire.begin();                               
  rtc.begin();
 // rtc.setDateTime(fecha) ; ///***************************

  pinMode(BUTTON_UP_PIN, INPUT_PULLUP);
  pinMode(BUTTON_DOWN_PIN, INPUT_PULLUP);
  pinMode(BUTTON_SELECT_PIN, INPUT_PULLUP); // select button
  pinMode(DEMO_PIN, INPUT_PULLUP);
  pinMode(BUTTON_PUSH_PIN, INPUT_PULLUP); // Configurar como salida
  EEPROM.begin(512); // Inicializa el espacio de EEPROM 
  dia_inicio1 = EEPROM.read(0); 
  mes_inicia1 = EEPROM.read(1);  
  
  // Calcular valores derivados
  mes_termina1 = mes_inicia1 + 2; 
  dia_termina1 = dia_inicio1;

 
 int dia_inicia_flora1 = dia_inicio1; // ejem será el 23
 int dia_termina_flora1 = dia_inicio1; // será el mismo día el 23 pero 2 meses después
 int mes_inicia_flora1 = mes_inicia1+2;
 int mes_termina_flora1 = mes_inicia1+4;
 
 
 Serial.begin(115200);
 
 dia_inicio=String(dia_inicio1, DEC);
 mes_inicia=String(mes_inicia1, DEC);
 dia_termina=String(dia_termina1, DEC);
 mes_termina=String(mes_termina1, DEC);
 dia_inicia_flora=String(dia_inicia_flora1, DEC);
 mes_inicia_flora=String(mes_inicia_flora1, DEC);
 mes_termina_flora=String(mes_termina_flora1, DEC);
  
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);

 Serial.println("Conectando....." );
  Serial.println("intento:" );
 int i = 1;
 while (WiFi.status() != WL_CONNECTED ) { 
  delay(500);
   
  Serial.print("          " );
  Serial.print(String(i));
  delay(500);
   
  conectaWifi();
  i++;
  }


}

void loop() {

}
